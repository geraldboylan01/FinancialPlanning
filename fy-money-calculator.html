<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>F*ck You Money Calculator</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 2rem auto; padding: 1rem; }
    .form-group { margin-bottom: 1rem; }
    label { display: block; margin-bottom: .35rem; }
    input[type="number"], input[type="date"] { width: 100%; padding: .5rem; }
    .checkbox-group, .radio-group { display: flex; gap: 1rem; flex-wrap: wrap; }
    button { padding: .7rem 1.5rem; font-size: 1rem; cursor: pointer; }
    #results { margin-top: 2rem; padding: 1.2rem; border: 1px solid #ccc; background: #f9f9f9; }
    .error { color: red; margin-top: 1rem; }
    #chart-container { margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>F*ck You Money Calculator</h1>
  <form id="fyf-form" autocomplete="off">
    <div class="form-group">
      <label for="grossIncome">Gross annual income (€)</label>
      <input type="number" id="grossIncome" required />
    </div>
    <div class="form-group">
      <label for="incomePercent">% of income needed in retirement</label>
      <input type="number" id="incomePercent" step="0.1" min="0" max="100" value="70" required />
    </div>
    <div class="form-group checkbox-group">
      <div><input type="checkbox" id="statePension" /> <label for="statePension">Collect State Pension (you)</label></div>
      <div><input type="checkbox" id="partnerStatePension" /> <label for="partnerStatePension">Partner entitled to State Pension</label></div>
    </div>
    <div id="partner-dob-group" class="form-group" style="display:none;">
      <label for="partnerDob">Partner date of birth</label>
      <input type="date" id="partnerDob" />
    </div>
    <div class="form-group">
      <label for="dob">Your date of birth</label>
      <input type="date" id="dob" required />
    </div>
    <div class="form-group">
      <label for="retireAge">Desired retirement age</label>
      <input type="number" id="retireAge" min="50" max="100" value="65" required />
    </div>
    <div class="form-group">
      <label>Portfolio growth rate</label>
      <div class="radio-group">
        <label><input type="radio" name="growthRate" value="0.04" /> 4% (40:60)</label>
        <label><input type="radio" name="growthRate" value="0.05" checked /> 5% (50:50)</label>
        <label><input type="radio" name="growthRate" value="0.06" /> 6% (60:40)</label>
        <label><input type="radio" name="growthRate" value="0.07" /> 7% (100:0)</label>
      </div>
    </div>
    <div class="form-group">
      <label for="rentalIncome">Annual rental income (€)</label>
      <input type="number" id="rentalIncome" placeholder="e.g. 12000" />
    </div>
    <div class="form-group">
      <label for="otherIncome">Other recurring income (€)</label>
      <input type="number" id="otherIncome" placeholder="e.g. defined benefit pension" />
    </div>
    <button type="submit">Calculate</button>
  </form>

  <div id="results"></div>
  <div id="chart-container"><canvas id="balanceChart"></canvas></div>
  <div id="console" class="error"></div>

  <script>
    const CPI_RATE = 0.023;
    const STATE_PENSION_AMOUNT = 15044;
    const SP_START_AGE = 66;
    let chart;

    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('partnerStatePension').addEventListener('change', function () {
        document.getElementById('partner-dob-group').style.display = this.checked ? 'block' : 'none';
      });
      document.getElementById('fyf-form').addEventListener('submit', calculate);
    });

    function ageInYears(date, ref) {
      return (ref - date) / (1000 * 60 * 60 * 24 * 365.25);
    }

    function calculate(e) {
      e.preventDefault();
      try {
        const gross = parseFloat(document.getElementById('grossIncome').value);
        const pctNeed = parseFloat(document.getElementById('incomePercent').value) / 100;
        const includeSP = document.getElementById('statePension').checked;
        const includePartnerSP = document.getElementById('partnerStatePension').checked;
        const dob = new Date(document.getElementById('dob').value);
        const partnerDobStr = document.getElementById('partnerDob').value;
        const partnerDob = partnerDobStr ? new Date(partnerDobStr) : null;
        const retireAge = parseInt(document.getElementById('retireAge').value);
        const growthRate = parseFloat(document.querySelector('input[name="growthRate"]:checked').value);
        const rentalAnnual = parseFloat(document.getElementById('rentalIncome').value) || 0;
        const otherAnnual = parseFloat(document.getElementById('otherIncome').value) || 0;

        if (isNaN(gross) || isNaN(pctNeed) || isNaN(retireAge) || isNaN(dob.getTime())) {
          throw new Error('Please fill all required fields correctly.');
        }

        const now = new Date();
        const currentAge = ageInYears(dob, now);
        const yearsToRetire = retireAge - currentAge;
        const yearsRetired = 100 - retireAge;
        const partnerCurrentAge = partnerDob ? ageInYears(partnerDob, now) : null;
        const partnerAgeAtRetire = partnerDob ? partnerCurrentAge + yearsToRetire : null;

        const baseNeed = gross * pctNeed;
        const needAtRetire = baseNeed * Math.pow(1 + CPI_RATE, yearsToRetire);

        let requiredCapital = 0;
        let balance = 0;
        let balances = [];
        let alwaysSurplus = true;

        for (let t = 0; t < yearsRetired; t++) {
          const age = retireAge + t;
          const partnerAge = partnerDob ? partnerAgeAtRetire + t : null;
          const inflationFactor = Math.pow(1 + CPI_RATE, t);
          const req = needAtRetire * inflationFactor;
          const rent = rentalAnnual * inflationFactor;
          const other = otherAnnual * inflationFactor;

          let sp = 0;
          if (includeSP && age >= SP_START_AGE) sp += STATE_PENSION_AMOUNT;
          if (includePartnerSP && partnerAge && partnerAge >= SP_START_AGE) sp += STATE_PENSION_AMOUNT;

          const netWithdrawal = req - sp - rent - other;
          if (netWithdrawal > 0) {
            alwaysSurplus = false;
            requiredCapital += netWithdrawal / Math.pow(1 + growthRate, t + 1);
          }
        }

        requiredCapital = Math.max(0, Math.round(requiredCapital / 1000) * 1000);

        let currentBalance = requiredCapital;
        for (let t = 0; t < yearsRetired; t++) {
          const age = retireAge + t;
          const partnerAge = partnerDob ? partnerAgeAtRetire + t : null;
          const inflationFactor = Math.pow(1 + CPI_RATE, t);
          const req = needAtRetire * inflationFactor;
          const rent = rentalAnnual * inflationFactor;
          const other = otherAnnual * inflationFactor;

          let sp = 0;
          if (includeSP && age >= SP_START_AGE) sp += STATE_PENSION_AMOUNT;
          if (includePartnerSP && partnerAge && partnerAge >= SP_START_AGE) sp += STATE_PENSION_AMOUNT;

          const netWithdrawal = Math.max(0, req - sp - rent - other);
          currentBalance = currentBalance * (1 + growthRate) - netWithdrawal;
          balances.push({ age, value: Math.max(0, Math.round(currentBalance)) });
        }

        const chartData = {
          labels: balances.map(d => `Age ${d.age}`),
          datasets: [{
            label: 'Pension Balance (€)',
            data: balances.map(d => d.value),
            borderColor: '#00cc99',
            backgroundColor: 'rgba(0,204,153,0.1)',
            fill: true,
            tension: 0.3
          }]
        };

        if (alwaysSurplus) {
          document.getElementById('results').innerHTML = `
            <h2>Congratulations!</h2>
            <p>Your income exceeds spending throughout retirement — no pension capital required.</p>
            <img src="https://media.giphy.com/media/5GoVLqeAOo6PK/giphy.gif" alt="Success meme" style="max-width:200px;margin-top:1rem;" />
          `;
        } else {
          document.getElementById('results').innerHTML = `
            <h2>Result</h2>
            <p>You need approximately <strong>€${requiredCapital.toLocaleString()}</strong> in your pension at retirement.</p>
          `;
        }

        if (chart) chart.destroy();
        chart = new Chart(document.getElementById('balanceChart'), {
          type: 'line',
          data: chartData,
          options: {
            responsive: true,
            scales: {
              y: {
                ticks: {
                  callback: val => '€' + val.toLocaleString()
                }
              }
            }
          }
        });
      } catch (err) {
        document.getElementById('console').textContent = err.message;
        document.getElementById('results').innerHTML = '';
      }
    }
  </script>
</body>
</html>
