<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pension Growth Projection</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:'Inter',sans-serif;background:#1a1a1a;color:#fff}
    h1{font-weight:700;margin-top:0;text-align:center}
    .wrapper{min-height:100%;display:flex;justify-content:center;align-items:flex-start;padding:2rem 1rem}
    .card{width:100%;max-width:640px;background:#2a2a2a;border-radius:16px;box-shadow:0 0 25px rgba(0,255,136,.25);padding:2rem}
    .form-group{margin-bottom:1rem}
    label{display:block;margin-bottom:.4rem;font-weight:600}
    input[type=number],input[type=date]{width:100%;padding:.55rem .7rem;border:none;border-radius:8px;background:#404040;color:#fff}
    input::placeholder{color:#aaa}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .radio-group{display:flex;gap:1rem;flex-wrap:wrap}
    button{margin-top:1rem;width:100%;padding:.8rem 1rem;font-weight:700;font-size:1rem;border:none;border-radius:50px;cursor:pointer;color:#1a1a1a;background:linear-gradient(135deg,#00ff88,#0099ff);transition:transform .25s,box-shadow .25s}
    button:hover{transform:scale(1.03);box-shadow:0 0 22px rgba(0,255,136,.8)}
    #results{margin-top:2rem;background:#333;border-radius:12px;padding:1rem 1.2rem}
    #chart-container{margin-top:1.5rem}
    .error{color:#ff5c5c;margin-top:.5rem}
  </style>
</head>
<body>
  <div class="wrapper">
    <div class="card">
      <h1>Pension Projection Tool</h1>

      <form id="proj-form" autocomplete="off">
        <div class="form-group">
          <label for="salary">Gross salary (€) <small>(max €115 000 is used in calculations)</small></label>
          <input type="number" id="salary" required />
        </div>

        <div class="form-group">
          <label for="currentValue">Current pension value (€)</label>
          <input type="number" id="currentValue" required />
        </div>

        <div class="two-col">
          <div class="form-group">
            <label for="personalContrib">Your annual contribution (€)</label>
            <input type="number" id="personalContrib" placeholder="Leave blank if % instead" />
          </div>
          <div class="form-group">
            <label for="personalPct">% of salary</label>
            <input type="number" id="personalPct" step="0.1" placeholder="Leave blank if € used" />
          </div>
        </div>

        <div class="two-col">
          <div class="form-group">
            <label for="employerContrib">Employer annual contribution (€)</label>
            <input type="number" id="employerContrib" placeholder="Leave blank if % instead" />
          </div>
          <div class="form-group">
            <label for="employerPct">% of salary</label>
            <input type="number" id="employerPct" step="0.1" placeholder="Leave blank if € used" />
          </div>
        </div>

        <div class="form-group">
          <label for="dob">Your date of birth</label>
          <input type="date" id="dob" required />
        </div>

        <div class="form-group">
          <label for="retireAge">Desired retirement age</label>
          <input type="number" id="retireAge" min="50" max="70" value="65" required />
        </div>

        <div class="form-group">
          <label>Growth profile</label>
          <div class="radio-group">
            <label><input type="radio" name="growth" value="0.04"> Low&nbsp;Risk&nbsp;(4%)</label>
            <label><input type="radio" name="growth" value="0.05" checked> Medium&nbsp;Risk&nbsp;(5%)</label>
            <label><input type="radio" name="growth" value="0.06"> High&nbsp;Risk&nbsp;(6%)</label>
            <label><input type="radio" name="growth" value="0.07"> 100%&nbsp;Equity&nbsp;Risk&nbsp;(7%)</label>
          </div>
        </div>

        <button type="submit">Project value</button>
      </form>

      <div id="results"></div>
      <div id="chart-container"><canvas id="growthChart"></canvas></div>
      <div id="console" class="error"></div>
    </div>
  </div>

<script>
const MAX_SALARY_CAP = 115000;
const AGE_BANDS = [
  { max: 29,  pct: 0.15 },
  { max: 39,  pct: 0.20 },
  { max: 49,  pct: 0.25 },
  { max: 54,  pct: 0.30 },
  { max: 59,  pct: 0.35 },
  { max: 120, pct: 0.40 }
];

let growthChart = null;
let balances = [],       // will hold base scenario data
    currentPv,           // will hold the lump-sum start
    curAge,              // current age in years
    yearsToRet,
    salaryCapped,
    personalUsed,
    employerCalc,
    gRate,
    retireAge;

// Helper functions
function ageInYears(date, ref) {
  return (ref - date) / (1000 * 60 * 60 * 24 * 365.25);
}
function maxPersonalPct(age) {
  return AGE_BANDS.find(b => age <= b.max).pct;
}
function maxPersonalByAge(age, capSalary) {
  return maxPersonalPct(Math.floor(age)) * capSalary;
}

// Ensure the "Show max" toggle lives under the chart-container
function ensureMaxToggleExists() {
  if (document.getElementById('maxToggle')) return;
  const div = document.createElement('div');
  div.className = 'form-group';
  div.style.marginTop = '1rem';
  div.innerHTML = `
    <label>
      <input type="checkbox" id="maxToggle">
      Show max-contribution scenario
    </label>
  `;
  document.querySelector('#chart-container').insertAdjacentElement('afterend', div);
  document.getElementById('maxToggle').addEventListener('change', drawChart);
}

// Core chart-drawing, uses the global variables set by the form submit
function drawChart() {
  const showMax = document.getElementById('maxToggle')?.checked;

  // Base dataset
  const datasets = [{
    label: 'Your Projection',
    data: balances.map(b => b.value),
    borderColor: '#00ff88',
    backgroundColor: 'rgba(0,255,136,0.15)',
    fill: true,
    tension: 0.25
  }];

  // Optional max-contribution dataset
  let extraText = '';
  if (showMax) {
    const maxBalances = [];
    let maxBal = currentPv;
    for (let y = 1; y <= yearsToRet; y++) {
      const ageNext = curAge + y;
      const personalMax = maxPersonalByAge(ageNext, salaryCapped);
      maxBal = maxBal * (1 + gRate) + personalMax + employerCalc;
      maxBalances.push({ age: Math.floor(ageNext), value: Math.round(maxBal) });
    }
    datasets.push({
      label: 'Max Contribution',
      data: maxBalances.map(b => b.value),
      borderColor: '#0099ff',
      borderDash: [6, 4],
      fill: false,
      tension: 0.25
    });
    extraText = `<p><em>Max-contribution value at ${retireAge}: <strong>€${maxBalances.at(-1).value.toLocaleString()}</strong></em></p>`;
  }

  // Render the chart
  if (growthChart) growthChart.destroy();
  growthChart = new Chart(document.getElementById('growthChart'), {
    type: 'line',
    data: {
      labels: balances.map(b => `Age ${b.age}`),
      datasets
    },
    options: {
      responsive: true,
      plugins: { legend: { position: 'top' } },
      scales: {
        y: { ticks: { callback: v => '€' + v.toLocaleString() } }
      }
    }
  });

  // Append the extra line only once (so it doesn’t duplicate)
  const resultsDiv = document.getElementById('results');
  // Remove any previous extra line
  resultsDiv.querySelectorAll('.max-note').forEach(el => el.remove());
  if (extraText) {
    const wrapper = document.createElement('div');
    wrapper.className = 'max-note';
    wrapper.innerHTML = extraText;
    resultsDiv.append(wrapper);
  }
}

// Handle form submission
document.getElementById('proj-form').addEventListener('submit', e => {
  e.preventDefault();
  try {
    // Read & prepare inputs
    const salaryRaw   = +document.getElementById('salary').value;
    salaryCapped     = Math.min(salaryRaw, MAX_SALARY_CAP);
    currentPv        = +document.getElementById('currentValue').value;
    const personalRaw= +document.getElementById('personalContrib').value || 0;
    const personalPct= (+document.getElementById('personalPct').value || 0) / 100;
    employerCalc     = (+document.getElementById('employerContrib').value || 0) > 0
                      ? +document.getElementById('employerContrib').value
                      : salaryCapped * ((+document.getElementById('employerPct').value||0)/100);
    retireAge        = +document.getElementById('retireAge').value;
    gRate            = +document.querySelector('input[name="growth"]:checked').value;
    const dob        = new Date(document.getElementById('dob').value);

    if (!salaryRaw || !currentPv || !dob) {
      throw 'Please fill salary, DOB and current value';
    }

    // Calculate personalUsed
    curAge    = ageInYears(dob, new Date());
    const personalCalcRaw = personalRaw > 0
      ? personalRaw
      : salaryCapped * personalPct;
    const limitValue      = maxPersonalPct(Math.floor(curAge)) * salaryCapped;
    personalUsed          = Math.min(personalCalcRaw, limitValue);

    // Prepare balances array
    yearsToRet = Math.max(0, retireAge - curAge);
    balances   = [];
    let bal    = currentPv;
    for (let y = 1; y <= yearsToRet; y++) {
      bal = bal * (1 + gRate) + personalUsed + employerCalc;
      balances.push({ age: Math.floor(curAge) + y, value: Math.round(bal) });
    }

    // Show base results
    document.getElementById('results').innerHTML = `
      <p>
        Max personal contribution allowed (age ${Math.floor(curAge)}):
        <strong>€${(maxPersonalPct(Math.floor(curAge)) * salaryCapped).toLocaleString()}</strong>
      </p>
      <p>
        Using <strong>€${personalUsed.toLocaleString()}</strong> personal +
        <strong>€${employerCalc.toLocaleString()}</strong> employer each year.
      </p>
      <h2>
        Projected value at age ${retireAge}:<br>
        <strong>€${balances.at(-1).value.toLocaleString()}</strong>
      </h2>
    `;

    // Inject toggle & draw chart
    ensureMaxToggleExists();
    drawChart();

    document.getElementById('console').textContent = '';
  } catch (err) {
    document.getElementById('console').textContent = err;
    if (growthChart) growthChart.destroy();
  }
});
</script>

</body>
</html>
